<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IMPETEC HUB PRO - V12.8 RESTORED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --primary: #004691; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; color: #1e293b; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e2e8f0; height: 100vh; position: fixed; z-index: 50; }
        .main { margin-left: 280px; height: 100vh; overflow-y: auto; padding: 40px; }
        .nav-link { padding: 12px 20px; display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 13px; color: #64748b; border-radius: 12px; margin: 4px 15px; transition: 0.2s; cursor: pointer; border: none; background: none; width: calc(100% - 30px); text-align: left; }
        .nav-link:hover, .nav-link.active { background: #eff6ff; color: var(--primary); }
        .kanban-col { width: 310px; flex-shrink: 0; background: #f1f5f9; border-radius: 20px; padding: 15px; min-height: 80vh; border: 1px solid #e2e8f0; }
        .card-deal { background: white; padding: 16px; border-radius: 15px; margin-bottom: 12px; border-bottom: 4px solid #cbd5e1; cursor: pointer; transition: 0.2s; }
        .card-deal:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
        .cal-header-day { background: white; padding: 15px; text-align: center; font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        .cal-day { min-height: 140px; background: white; border: 1px solid #f1f5f9; padding: 12px; cursor: pointer; transition: 0.2s; position: relative; }
        .cal-day:hover { background: #f8fafc; z-index: 10; box-shadow: inset 0 0 0 2px var(--primary); }
        .chat-float { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 450px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 100; transition: 0.3s; }
        .chat-float.minimized { height: 50px; overflow: hidden; }
        iframe { width: 100%; height: 88vh; border: none; border-radius: 15px; background: white; }
    </style>
</head>
<body>

<audio id="snd-chat" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>
<audio id="snd-pipeline" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>
<audio id="snd-agenda" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>

<div id="auth-wall" class="fixed inset-0 bg-slate-50 z-[9999] flex items-center justify-center">
    <div class="bg-white p-10 rounded-3xl shadow-xl w-96 text-center border">
        <div class="text-3xl font-black text-blue-900 mb-8 italic uppercase tracking-tighter">Impetec <span class="text-blue-500">Hub</span></div>
        <input type="text" id="u-in" placeholder="Operador" class="w-full border p-4 rounded-xl mb-4 outline-none focus:ring-2 ring-blue-500 text-center uppercase font-bold">
        <input type="password" id="p-in" placeholder="Contraseña" class="w-full border p-4 rounded-xl mb-8 outline-none focus:ring-2 ring-blue-500 text-center">
        <button onclick="login()" class="w-full bg-blue-900 text-white p-4 rounded-xl font-bold hover:bg-blue-800 uppercase tracking-widest">Entrar</button>
    </div>
</div>

<aside class="sidebar flex flex-col">
    <div class="p-8 text-2xl font-black text-blue-900 italic tracking-tighter uppercase">IMPETEC PRO</div>
    <nav class="flex-1 overflow-y-auto">
        <button onclick="tab('crm')" class="nav-link active" id="b-crm"><i class="fas fa-layer-group"></i> Pipeline Flow</button>
        <button onclick="tab('cal')" class="nav-link" id="b-cal"><i class="fas fa-calendar-alt"></i> Agenda Operativa</button>
        <button onclick="tab('bi')" class="nav-link" id="b-bi"><i class="fas fa-chart-line"></i> Dashboard BI</button>
        <div class="px-8 mt-6 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Documentos</div>
        <button onclick="tab('lev')" class="nav-link"><i class="fas fa-map-marker-alt"></i> Levantamiento</button>
        <button onclick="tab('cot')" class="nav-link"><i class="fas fa-calculator"></i> Cotizador</button>
        <button onclick="tab('os')" class="nav-link"><i class="fas fa-tools"></i> Orden Servicio</button>
        <button onclick="tab('rem')" class="nav-link"><i class="fas fa-file-invoice"></i> Remisiones</button>
        <button onclick="tab('edc')" class="nav-link"><i class="fas fa-wallet"></i> Edo. Cuenta</button>
        <button onclick="tab('ent')" class="nav-link"><i class="fas fa-check-double"></i> Entregable</button>
    </nav>
    <div class="p-6 border-t border-slate-100 bg-slate-50">
        <select id="m-sel" onchange="initApp()" class="w-full text-xs font-bold text-blue-600 bg-transparent outline-none mb-4 cursor-pointer"></select>
        <button onclick="logout()" class="text-red-500 text-[10px] font-bold uppercase w-full text-left">Cerrar Sesión</button>
    </div>
</aside>

<main class="main">
    <div id="v-crm" class="view-sec">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-bold text-slate-800">Pipeline <span class="text-blue-600">Comercial</span></h2>
            <button onclick="openDeal()" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:scale-105 transition-all uppercase text-xs">+ Nueva Negociación</button>
        </div>
        <div class="flex gap-6 overflow-x-auto pb-6">
            <div class="kanban-col" id="st-prospecto" ondrop="drop(event, 'prospecto')" ondragover="allow(event)"></div>
            <div class="kanban-col" id="st-cotizado" ondrop="drop(event, 'cotizado')" ondragover="allow(event)"></div>
            <div class="kanban-col" id="st-obra" ondrop="drop(event, 'obra')" ondragover="allow(event)"></div>
            <div class="kanban-col" id="st-ganado" ondrop="drop(event, 'ganado')" ondragover="allow(event)"></div>
            <div class="kanban-col opacity-60" id="st-perdido" ondrop="drop(event, 'perdido')" ondragover="allow(event)"></div>
        </div>
    </div>

    <div id="v-cal" class="view-sec hidden">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-slate-800">Agenda <span class="text-blue-600">Operativa</span></h2>
            <div class="bg-white px-4 py-2 rounded-xl border font-bold text-blue-600 text-sm shadow-sm" id="cal-month-label">---</div>
        </div>
        <div class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-t-2xl overflow-hidden">
            <div class="cal-header-day">Lun</div><div class="cal-header-day">Mar</div><div class="cal-header-day">Mié</div>
            <div class="cal-header-day">Jue</div><div class="cal-header-day">Vie</div><div class="cal-header-day text-blue-400">Sáb</div>
            <div class="cal-header-day text-red-400">Dom</div>
        </div>
        <div class="grid grid-cols-7 gap-px bg-slate-200 border-x border-b border-slate-200 rounded-b-2xl overflow-hidden shadow-inner" id="cal-render"></div>
    </div>

    <div id="v-bi" class="view-sec hidden">
        <h2 class="text-3xl font-bold text-slate-800 mb-10">Métricas del Mes</h2>
        <div class="grid grid-cols-4 gap-6" id="bi-stats">
            <div class="bg-white p-8 rounded-3xl border-l-8 border-blue-500 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase">Facturación</p><h3 id="stat-v" class="text-3xl font-black mt-2 text-slate-800">$0</h3></div>
            <div class="bg-white p-8 rounded-3xl border-l-8 border-red-400 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase">Inversión</p><h3 id="stat-c" class="text-3xl font-black mt-2 text-slate-800">$0</h3></div>
            <div class="bg-white p-8 rounded-3xl border-l-8 border-green-500 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase">Utilidad</p><h3 id="stat-u" class="text-3xl font-black mt-2 text-green-600">$0</h3></div>
            <div class="bg-white p-8 rounded-3xl border-l-8 border-purple-500 shadow-sm"><p class="text-[10px] font-bold text-slate-400 uppercase">% Éxito</p><h3 id="stat-h" class="text-3xl font-black mt-2 text-slate-800">0%</h3></div>
        </div>
    </div>

    <div id="v-lev" class="view-sec hidden"><iframe src="ORDEN DE LEVANTAMIENTO.html"></iframe></div>
    <div id="v-cot" class="view-sec hidden"><iframe src="MACHOTE DE COTIZACION.html"></iframe></div>
    <div id="v-os" class="view-sec hidden"><iframe src="ORDENES DE SERVICIO.HTML"></iframe></div>
    <div id="v-rem" class="view-sec hidden"><iframe src="REMISIONES-NDC IMPETEC.HTML"></iframe></div>
    <div id="v-edc" class="view-sec hidden"><iframe src="ESTADO DE CUENTA.html"></iframe></div>
    <div id="v-ent" class="view-sec hidden"><iframe src="ENTREGABLE_TECNICO.HTML"></iframe></div>
</main>

<div id="chat-ui" class="chat-float minimized">
    <div class="bg-blue-900 p-4 text-white flex justify-between items-center cursor-pointer" onclick="this.parentElement.classList.toggle('minimized')">
        <span class="text-[10px] font-bold tracking-widest uppercase">Chat Interno</span>
        <i class="fas fa-chevron-up"></i>
    </div>
    <div id="chat-msgs" class="flex-1 p-4 overflow-y-auto space-y-3 bg-slate-50"></div>
    <div class="p-3 border-t bg-white flex gap-2">
        <input type="text" id="chat-in" class="flex-1 border p-2 rounded-lg text-sm outline-none" placeholder="Mensaje...">
        <button onclick="sendMsg()" class="bg-blue-600 text-white px-3 rounded-lg"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="m-deal" class="fixed inset-0 bg-black/60 hidden z-[2000] flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white p-10 rounded-3xl w-[450px] shadow-2xl">
        <input type="hidden" id="f-id">
        <input type="hidden" id="f-st">
        <h3 class="text-xl font-bold mb-6 text-slate-800">Expediente de Negocio</h3>
        <div class="space-y-4">
            <input type="text" id="f-cli" placeholder="Nombre Cliente" class="w-full border p-4 rounded-xl outline-none focus:ring-2 ring-blue-500">
            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="f-mon" placeholder="Venta $" class="w-full border p-4 rounded-xl font-bold">
                <input type="number" id="f-cos" placeholder="Costo $" class="w-full border p-4 rounded-xl font-bold text-red-500">
            </div>
            <input type="text" id="f-tel" placeholder="WhatsApp (Ej: 521...)" class="w-full border p-4 rounded-xl">
            <select id="f-ser" class="w-full border p-4 rounded-xl font-bold"><option>CCTV</option><option>GPS</option><option>REDES</option><option>ALARMAS</option></select>
            <div class="flex gap-2 pt-4">
                <button onclick="saveDeal()" class="flex-1 bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg uppercase">Guardar</button>
                <button onclick="deleteDeal()" id="btn-del-deal" class="bg-red-50 text-red-500 px-5 rounded-xl hidden"><i class="fas fa-trash"></i></button>
            </div>
            <button onclick="document.getElementById('m-deal').classList.add('hidden')" class="w-full text-slate-400 text-xs mt-2 uppercase font-bold text-center">Cancelar</button>
        </div>
    </div>
</div>

<div id="m-cal" class="fixed inset-0 bg-black/60 hidden z-[2000] flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white p-10 rounded-3xl w-96 shadow-2xl">
        <input type="hidden" id="ev-id">
        <h3 class="text-xl font-bold mb-6 text-slate-800 uppercase tracking-tighter">Actividad</h3>
        <div class="space-y-4">
            <input type="time" id="ev-time" class="w-full border p-4 rounded-xl outline-none font-black text-blue-600 text-xl">
            <textarea id="ev-txt" class="w-full border p-4 rounded-xl h-24 outline-none focus:ring-2 ring-blue-500" placeholder="¿Qué se hará?"></textarea>
            <div class="flex gap-2">
                <button onclick="saveEvent()" class="flex-1 bg-blue-600 text-white p-4 rounded-xl font-bold uppercase">Agendar</button>
                <button onclick="deleteEvent()" id="btn-del-ev" class="bg-red-50 text-red-500 px-5 rounded-xl hidden"><i class="fas fa-trash"></i></button>
            </div>
            <button onclick="document.getElementById('m-cal').classList.add('hidden')" class="w-full text-slate-400 text-xs mt-2 font-bold uppercase text-center">Cerrar</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://impetec-hub-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let me = localStorage.getItem('imp_user'), deals = [], curM, curY, selD, firstLoad = true;

    function playSound(id) { document.getElementById(id).play().catch(e => {}); }

    function login() {
        const u = document.getElementById('u-in').value.toLowerCase().trim(), p = document.getElementById('p-in').value;
        db.ref(`users/${u}`).once('value', s => { 
            if(s.exists() && s.val().pass === p) { me = u; localStorage.setItem('imp_user', u); location.reload(); }
        });
    }
    if(me) document.getElementById('auth-wall').classList.add('hidden');

    function tab(t) {
        document.querySelectorAll('.view-sec').forEach(d => d.classList.add('hidden'));
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        document.getElementById('v-'+t).classList.remove('hidden');
        document.getElementById('b-'+t)?.classList.add('active');
        if(t === 'cal') renderCal();
    }

    // --- PIPELINE LOGIC RESTORED ---
    function openDeal(id = null) {
        const d = id ? deals.find(x => x.id === id) : null;
        document.getElementById('f-id').value = id || '';
        document.getElementById('f-st').value = d ? d.status : 'prospecto';
        document.getElementById('f-cli').value = d ? d.cliente : '';
        document.getElementById('f-mon').value = d ? d.monto : '';
        document.getElementById('f-cos').value = d ? d.costo : '';
        document.getElementById('f-tel').value = d ? d.tel : '';
        document.getElementById('f-ser').value = d ? d.servicio : 'CCTV';
        document.getElementById('btn-del-deal').classList.toggle('hidden', !id);
        document.getElementById('m-deal').classList.remove('hidden');
    }

    function saveDeal() {
        const id = document.getElementById('f-id').value || 'ID-' + Date.now();
        const data = {
            id, cliente: document.getElementById('f-cli').value || 'S/N',
            monto: parseFloat(document.getElementById('f-mon').value) || 0,
            costo: parseFloat(document.getElementById('f-cos').value) || 0,
            tel: document.getElementById('f-tel').value || '',
            servicio: document.getElementById('f-ser').value,
            status: document.getElementById('f-st').value || 'prospecto',
            last_by: me, ts: Date.now()
        };
        db.ref(`deals/${curM}-${curY}/${id}`).set(data).then(() => {
            document.getElementById('m-deal').classList.add('hidden');
        });
    }

    function loadDeals() {
        const ref = db.ref(`deals/${curM}-${curY}`);
        ref.limitToLast(1).on('child_changed', () => { if(!firstLoad) playSound('snd-pipeline'); });
        ref.limitToLast(1).on('child_added', () => { if(!firstLoad) playSound('snd-pipeline'); });

        ref.on('value', snap => {
            deals = snap.val() ? Object.values(snap.val()) : [];
            ['prospecto', 'cotizado', 'obra', 'ganado', 'perdido'].forEach(s => {
                document.getElementById('st-'+s).innerHTML = `<p class="text-[10px] font-black text-slate-400 mb-6 uppercase text-center tracking-widest">${s}</p>`;
            });
            deals.forEach(d => {
                const card = document.createElement('div');
                card.className = "card-deal"; card.draggable = true;
                card.ondragstart = (e) => e.dataTransfer.setData("text", d.id);
                card.onclick = () => openDeal(d.id);
                card.innerHTML = `<div class="flex justify-between items-start mb-2"><span class="text-[9px] font-black text-blue-600 uppercase">${d.servicio}</span><a href="https://wa.me/${d.tel}" target="_blank" onclick="event.stopPropagation()"><i class="fab fa-whatsapp text-green-500"></i></a></div>
                    <div class="font-bold text-slate-700 text-sm truncate">${d.cliente}</div>
                    <div class="text-xl font-black text-slate-900 mt-1">$${d.monto.toLocaleString()}</div>
                    <div class="mt-4 pt-2 border-t text-[8px] text-slate-400 flex justify-between uppercase font-bold italic"><span>${d.last_by || 'Auto'}</span><i class="fas fa-history"></i></div>`;
                document.getElementById('st-'+d.status).appendChild(card);
            });
            renderBI();
        });
    }

    function drop(e, st) { e.preventDefault(); const id = e.dataTransfer.getData("text"); if(id) db.ref(`deals/${curM}-${curY}/${id}`).update({ status: st, last_by: me, ts: Date.now() }); }
    function allow(e) { e.preventDefault(); }
    function deleteDeal() { if(confirm('¿Eliminar?')) db.ref(`deals/${curM}-${curY}/${document.getElementById('f-id').value}`).remove().then(()=>document.getElementById('m-deal').classList.add('hidden')); }

    // --- AGENDA LOGIC RESTORED ---
    function renderCal() {
        const grid = document.getElementById('cal-render'); grid.innerHTML = '';
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        document.getElementById('cal-month-label').innerText = monthNames[curM].toUpperCase() + ' ' + curY;
        const firstDay = new Date(curY, curM, 1).getDay();
        const offset = firstDay === 0 ? 6 : firstDay - 1;
        const dInM = new Date(curY, parseInt(curM)+1, 0).getDate();
        for(let i=0; i<offset; i++) grid.innerHTML += `<div class="bg-slate-50/50"></div>`;
        
        const ref = db.ref(`agenda/${curM}-${curY}`);
        ref.on('child_changed', () => { if(!firstLoad) playSound('snd-agenda'); });
        ref.on('child_added', () => { if(!firstLoad) playSound('snd-agenda'); });

        ref.on('value', snap => {
            const evs = snap.val() || {};
            grid.querySelectorAll('.cal-day').forEach(el => el.remove());
            for(let i=1; i<=dInM; i++) {
                const cell = document.createElement('div'); cell.className = 'cal-day';
                cell.onclick = () => { selD = i; document.getElementById('ev-id').value = ''; document.getElementById('ev-txt').value = ''; document.getElementById('ev-time').value = ''; document.getElementById('btn-del-ev').classList.add('hidden'); document.getElementById('m-cal').classList.remove('hidden'); };
                let h = `<span class="text-sm font-black text-slate-400">${i}</span><div class="mt-3 space-y-2">`;
                if(evs['d'+i]) {
                    Object.entries(evs['d'+i]).forEach(([id, ev]) => {
                        h += `<div onclick="event.stopPropagation(); editEv('${id}', '${ev.txt}', '${ev.time}', ${i})" class="bg-blue-600 text-white text-[9px] p-2 rounded-lg font-bold shadow-sm border-l-4 border-blue-900">
                                <div class="flex justify-between items-center opacity-70 mb-1"><span>${ev.time || '--:--'}</span><span class="text-[7px] uppercase">${ev.user || ''}</span></div>
                                <div class="truncate">${ev.txt}</div></div>`;
                    });
                }
                cell.innerHTML = h + '</div>';
                grid.appendChild(cell);
            }
        });
    }

    function editEv(id, txt, time, day) {
        selD = day; document.getElementById('ev-id').value = id; document.getElementById('ev-txt').value = txt; document.getElementById('ev-time').value = time || '';
        document.getElementById('btn-del-ev').classList.remove('hidden'); document.getElementById('m-cal').classList.remove('hidden');
    }

    function saveEvent() {
        const id = document.getElementById('ev-id').value;
        const data = { txt: document.getElementById('ev-txt').value, time: document.getElementById('ev-time').value, user: me };
        const path = `agenda/${curM}-${curY}/d${selD}`;
        if(id) db.ref(`${path}/${id}`).update(data);
        else db.ref(path).push(data);
        document.getElementById('m-cal').classList.add('hidden');
    }
    function deleteEvent() { if(confirm('¿Borrar?')) db.ref(`agenda/${curM}-${curY}/d${selD}/${document.getElementById('ev-id').value}`).remove().then(()=>document.getElementById('m-cal').classList.add('hidden')); }

    // --- OTHER CORE ---
    function sendMsg() {
        const i = document.getElementById('chat-in'); if(!i.value.trim()) return;
        db.ref('chat').push({ u: me, m: i.value, ts: Date.now() }); i.value = '';
    }
    db.ref('chat').limitToLast(1).on('child_added', snap => { if(!firstLoad) playSound('snd-chat'); });
    db.ref('chat').limitToLast(15).on('value', snap => {
        const a = document.getElementById('chat-msgs'); a.innerHTML = '';
        snap.forEach(s => {
            const d = s.val(); const isMe = d.u === me;
            a.innerHTML += `<div class="flex ${isMe?'justify-end':'justify-start'}"><div class="${isMe?'bg-blue-600 text-white':'bg-white border text-slate-600'} p-3 rounded-xl max-w-[85%] shadow-sm"><p class="text-[7px] font-black uppercase mb-1 opacity-50">${d.u}</p><p class="text-xs font-medium">${d.m}</p></div></div>`;
        });
        a.scrollTop = a.scrollHeight;
    });

    function renderBI() {
        let v=0, c=0, g=0, p=0;
        deals.forEach(d => { if(d.status==='ganado') { v+=d.monto; c+=d.costo; g++; } if(d.status==='perdido') p++; });
        document.getElementById('stat-v').innerText = '$'+v.toLocaleString();
        document.getElementById('stat-c').innerText = '$'+c.toLocaleString();
        document.getElementById('stat-u').innerText = '$'+(v-c).toLocaleString();
        document.getElementById('stat-h').innerText = (g+p>0?Math.round(g/(g+p)*100):0)+'%';
    }

    function initApp() {
        curM = document.getElementById('m-sel').value; curY = new Date().getFullYear();
        if(me) { loadDeals(); if(document.getElementById('v-cal').classList.contains('hidden') === false) renderCal(); }
    }

    window.onload = () => {
        const ms = document.getElementById('m-sel'), n = new Date();
        ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"].forEach((t,i)=>{
            const o=document.createElement('option'); o.value=i; o.innerText=t; if(i===n.getMonth()) o.selected=true; ms.appendChild(o);
        });
        initApp();
        setTimeout(() => { firstLoad = false; }, 2000);
    };
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>