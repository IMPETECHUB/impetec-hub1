<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPETEC BI - ESTRATÉGICO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .stat-card { transition: all 0.3s ease; }
        .chart-container { position: relative; height: 280px; width: 100%; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="flex justify-between items-center mb-8 no-print">
        <div>
            <h1 class="text-2xl font-black text-blue-900 uppercase">Impetec <span class="text-blue-500">BI</span></h1>
            <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Dashboard de Analítica</p>
        </div>
        <div class="flex gap-2">
            <select id="bi-month" onchange="loadAnalytics()" class="bg-white border-2 border-blue-900 rounded-lg px-3 py-1 text-sm font-bold text-blue-900"></select>
            <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-1 rounded-lg font-bold text-[10px] uppercase">PDF</button>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="stat-card bg-white p-5 rounded-2xl shadow-sm border-b-4 border-blue-500">
            <p class="text-[9px] font-black text-slate-400 uppercase">Ventas (Ganado)</p>
            <h2 id="kpi-total" class="text-2xl font-black text-slate-800">$0.00</h2>
        </div>
        <div class="stat-card bg-white p-5 rounded-2xl shadow-sm border-b-4 border-amber-500">
            <p class="text-[9px] font-black text-slate-400 uppercase">Pipeline Activo</p>
            <h2 id="kpi-pipeline" class="text-2xl font-black text-slate-800">$0.00</h2>
        </div>
        <div class="stat-card bg-white p-5 rounded-2xl shadow-sm border-b-4 border-green-500">
            <p class="text-[9px] font-black text-slate-400 uppercase">Eficiencia</p>
            <h2 id="kpi-rate" class="text-2xl font-black text-slate-800">0%</h2>
        </div>
        <div class="stat-card bg-white p-5 rounded-2xl shadow-sm border-b-4 border-red-500">
            <p class="text-[9px] font-black text-slate-400 uppercase">Perdidos</p>
            <h2 id="kpi-lost" class="text-2xl font-black text-slate-800">$0.00</h2>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-2xl shadow-sm border">
            <h3 class="text-xs font-black text-blue-900 uppercase mb-4 italic">Estado de Proyectos</h3>
            <div class="chart-container"><canvas id="chartPie"></canvas></div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border">
            <h3 class="text-xs font-black text-blue-900 uppercase mb-4 italic">Top Facturación</h3>
            <div class="chart-container"><canvas id="chartBar"></canvas></div>
        </div>
    </div>

    <script>
        // Configuración centralizada
        const config = { databaseURL: "https://impetec-hub-default-rtdb.firebaseio.com/" };
        
        try {
            if (!firebase.apps.length) firebase.initializeApp(config);
            var db = firebase.database();
        } catch (e) {
            console.error("Error inicializando Firebase:", e);
        }

        let chartPie, chartBar;

        function init() {
            const ms = document.getElementById('bi-month'), n = new Date();
            const names = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
            names.forEach((t,i) => { 
                const o = document.createElement('option'); o.value = i; o.innerText = t; 
                if(i === n.getMonth()) o.selected = true; ms.appendChild(o); 
            });
            loadAnalytics();
        }

        function loadAnalytics() {
            const m = document.getElementById('bi-month').value;
            const y = new Date().getFullYear();
            
            // Usamos .once para evitar bucles de carga en GitHub
            db.ref(`deals/${m}-${y}`).on('value', snap => {
                const data = snap.val() ? Object.values(snap.val()) : [];
                render(data);
            }, err => {
                console.warn("Bloqueo de lectura:", err.message);
                alert("Atención: No se pudieron cargar los datos. Revisa las reglas de tu base de datos.");
            });
        }

        function render(deals) {
            let s = { prospecto:0, cotizado:0, obra:0, ganado:0, perdido:0 }, c = {}, g=0, p=0, l=0;

            deals.forEach(d => {
                const val = parseFloat(d.monto) || 0;
                const st = (d.status || '').toLowerCase();
                if(s.hasOwnProperty(st)) s[st] += val;

                if(st === 'ganado') {
                    g += val;
                    if(d.cliente) c[d.cliente] = (c[d.cliente] || 0) + val;
                } else if(st === 'perdido') { l += val; } 
                else { p += val; }
            });

            document.getElementById('kpi-total').innerText = '$' + g.toLocaleString();
            document.getElementById('kpi-pipeline').innerText = '$' + p.toLocaleString();
            document.getElementById('kpi-lost').innerText = '$' + l.toLocaleString();
            document.getElementById('kpi-rate').innerText = (g+l > 0 ? (g/(g+l)*100).toFixed(1) : 0) + '%';

            updateCharts(s, c);
        }

        function updateCharts(s, c) {
            if(chartPie) chartPie.destroy();
            chartPie = new Chart(document.getElementById('chartPie'), {
                type: 'doughnut',
                data: {
                    labels: ['Pros', 'Cot', 'Obra', 'Gan', 'Per'],
                    datasets: [{
                        data: [s.prospecto, s.cotizado, s.obra, s.ganado, s.perdido],
                        backgroundColor: ['#94a3b8', '#f59e0b', '#3b82f6', '#22c55e', '#ef4444']
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            const top = Object.entries(c).sort((a,b) => b[1]-a[1]).slice(0, 5);
            if(chartBar) chartBar.destroy();
            chartBar = new Chart(document.getElementById('chartBar'), {
                type: 'bar',
                data: {
                    labels: top.map(x => x[0].substring(0,10)),
                    datasets: [{ data: top.map(x => x[1]), backgroundColor: '#1e3a8a' }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
